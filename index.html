<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Enciclopedia de Animales Mexicanos</title>
    <meta name="description" content="Proyecto dedicado a la investigación, difusión y divulgación de la fauna de México: fichas de especies, recursos educativos y colaboraciones.">
    <meta name="author" content="Enciclopedia de Animales Mexicanos">

    <!-- bootstrap css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- style css -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Responsive-->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- fevicon -->
    <link rel="icon" href="images/fevicon.png" type="image/gif">
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
    <!-- Icons -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
      :root{
        --bg:#f7faf7;
        --surface:#ffffff;
        --ink:#0f172a;
        --muted:#6b7280;
        --line:#e5e7eb;
        --accent:#16a34a;
        --accent-600:#15803d;
        --accent-700:#166534;
        --radius:16px;
        --shadow:0 10px 25px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06);
        --shadow-sm:0 6px 18px rgba(2,6,23,.08);
        --focus:0 0 0 3px rgba(22,163,74,.2), 0 1px 2px rgba(2,6,23,.08);
      }
      html, body{ background:var(--bg); color:var(--ink); }
      body{ font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
      h1,h2,h3,h4{ font-weight:700 }
      .longform{ font-family:"Merriweather", Georgia, Cambria, "Times New Roman", Times, serif; line-height:1.7 }

      /* ===== Header ===== */
      .site-header{position:sticky; top:0; z-index:1030; background:linear-gradient(180deg,#ffffff,#f7fff9); border-bottom:1px solid var(--line)}
      .site-header.stuck{box-shadow:var(--shadow)}
      .site-header .container{max-width:1200px}
      .mast{display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.85rem 0}
      .brand{display:flex; align-items:center; gap:.75rem}
      .brand img{width:44px; height:44px; object-fit:contain; border-radius:12px}
      .brand .title{font-weight:700; letter-spacing:.2px}
      .brand .sub{color:var(--muted); font-size:.9rem}
      .site-header nav.nav{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
      .site-header nav.nav a{padding:.5rem .75rem; border-radius:10px; color:#0f172a; text-decoration:none}
      .site-header nav.nav a[aria-current="page"], .site-header nav.nav a:hover{background:#ecfdf5; color:var(--accent)}

      /* ===== Buscador (mejorado) ===== */
      .site-search{ padding:.35rem 0 1rem; position:relative; overflow:visible; }
      .cv-search{ display:flex; align-items:center; gap:.6rem; background:#fff; border:1px solid var(--line); border-radius:999px; padding:.35rem .75rem; box-shadow:var(--shadow-sm); transition:box-shadow .15s, border-color .15s; width:min(620px,100%); }
      .cv-search:focus-within{ box-shadow:var(--focus); border-color:#cce3d3; }
      .cv-search svg{ flex:0 0 auto }
      .cv-search input{ border:0; outline:none; width:100%; padding:.35rem; background:transparent; font-size:1rem }
      .cv-kbd{ font-size:.75rem; color:#64748b; border:1px solid var(--line); border-radius:6px; padding:.05rem .35rem; background:#f8fafc }

      .search-panel{
        position:absolute; left:0; top:calc(100% + .4rem); width:min(720px,100%);
        background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
        z-index:1060; display:none; overflow:hidden;
      }
      .search-panel .sp-header{
        display:flex; align-items:center; justify-content:space-between;
        padding:.6rem .8rem; border-bottom:1px solid var(--line); background:#fcfefc;
      }
      .search-panel .sp-header strong{ font-weight:700; color:#0f172a; font-size:.95rem }
      .search-panel .sp-header button{ border:0; background:transparent; font-size:1.1rem; line-height:1; cursor:pointer; color:#64748b; }
      .search-panel .sp-list{ max-height:360px; overflow:auto; padding:.25rem }
      .sp-item{ display:grid; grid-template-columns: 1.3rem auto; gap:.65rem; padding:.6rem .75rem; cursor:pointer; align-items:flex-start; }
      .sp-item:hover{ background:#f7faf7 }
      .sp-item.active{ background:#ecfdf5; }
      .sp-ico{ width:1.2rem; text-align:center; color:#16a34a; margin-top:.15rem }
      .sp-type{ font-size:.7rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border:1px solid var(--line); border-radius:6px; padding:.05rem .35rem; margin-right:.5rem }
      .sp-main{ min-width:0 }
      .sp-title{ font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .sp-meta{ font-size:.82rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .sp-tags{ display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.25rem }
      .sp-chip{ border:1px solid #bbf7d0; background:#ecfdf5; color:#166534; border-radius:999px; padding:.12rem .45rem; font-size:.75rem }
      .hl{ background: #fef9c3; border-radius:4px; padding:0 .15rem; }

      /* Ajustes base existentes */
      img { max-width: 100%; height: auto; }
      .read_more { cursor: pointer; }
      .gallery_img figure, .about_img figure { margin: 0; }
      .loader_bg { display: none; }

      /* Convocatorias */
      .convocatorias-section { background:#f7f9f8; padding:40px 0; border-top:1px solid #e9ecef; }
      .titlepage .green{ color:var(--accent); }
      .cv-tools{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
      .cv-select{border:1px solid var(--line); background:#fff; border-radius:10px; padding:.55rem .7rem}
      .cv-btn{display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .8rem; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer}
      .cv-chips{display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.75rem}
      .cv-chip{display:inline-flex; align-items:center; gap:.35rem; border:1px solid #bbf7d0; background:#ecfdf5; color:var(--accent); padding:.25rem .6rem; border-radius:999px; font-size:.9rem; cursor:pointer}
      .cv-chip.active{background:#dcfce7; border-color:#86efac}
      .cv-empty{display:none; border:1px dashed var(--line); border-radius:12px; padding:2rem; text-align:center; color:var(--muted); background:#fff; margin-top:1rem}

      .pdf-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:1rem; padding:1.25rem 0 0; }
      @media (max-width: 480px){ .pdf-grid{ grid-template-columns: 1fr; } }
      .pdf-item{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; transition: transform .2s ease, box-shadow .2s ease; }
      .pdf-item.hide{ display:none !important; }
      .pdf-item:hover{ transform: translateY(-2px); box-shadow:0 18px 30px rgba(2,6,23,.10), 0 4px 14px rgba(2,6,23,.06); }
      .preview{ position:relative; background:linear-gradient(180deg,#f0f7f3,#e9f7ee); min-height:220px }
      .pdf-embed{ width:100%; height:380px; border:0; display:block; background:#f0f3f7; }
      @media (max-width: 576px){ .pdf-embed{ height:320px; } }
      .preview .hint{position:absolute; right:12px; bottom:12px; background:rgba(255,255,255,.85); border:1px solid var(--line); border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#64748b}
      .pdf-meta{ display:flex; flex-direction:column; gap:.6rem; padding:.9rem .9rem 1rem; }
      .pdf-name{ font-weight:700; line-height:1.35; word-break:break-word }
      .tag-row{ display:flex; flex-wrap:wrap; gap:.35rem }
      .badge-tag{ border:1px solid #bbf7d0; background:#ecfdf5; color:var(--accent); border-radius:999px; padding:.15rem .5rem; font-size:.8rem; }
      .actions{ display:flex; align-items:center; gap:.5rem; margin-top:.25rem }
      .btn-linklike{ display:inline-flex; align-items:center; gap:.45rem; border:1px solid var(--line); padding:.45rem .75rem; border-radius:10px; background:#fff; text-decoration:none; color:var(--accent); font-weight:600; }
      .btn-linklike:hover{ background:#f1fcf5; border-color:#cce3d3; }

      @media (prefers-reduced-motion: reduce) { .carousel, .carousel-item{ transition:none!important } }
    </style>
  </head>
  <body class="main-layout">
    <!-- ===== Header ===== -->
    <header id="siteHeader" class="site-header" role="banner">
      <div class="container">
        <div class="mast">
          <div class="brand">
            <a href="index.html" aria-label="Ir al inicio">
              <img src="images/Logo EAM.png" alt="EAM logo" loading="eager" decoding="async" fetchpriority="high" style="width:190px; height:auto;">
            </a>
            <div>
              <div class="title">Enciclopedia de Animales Mexicanos</div>
              <div class="sub">Inicio</div>
            </div>
          </div>
          <nav class="nav" aria-label="Navegación principal">
            <a href="index.html" aria-current="page">Inicio</a>
            <a href="humanidad-animalidad.html">Animalidad y Humanidad</a>
            <a href="about.html">Nosotros</a>
            <a href="service.html">Especies</a>
            <a href="contact.html">Contacto</a>
          </nav>
        </div>

        <!-- ===== Buscador ===== -->
        <div class="site-search" role="search">
          <label class="cv-search header-search" for="headerQ" title="Buscar en el sitio">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#64748b" stroke-width="2" stroke-linecap="round"/><circle cx="10.5" cy="10.5" r="6.5" stroke="#64748b" stroke-width="2"/></svg>
            <input id="headerQ" placeholder="Busca secciones, fichas y convocatorias…" autocomplete="off" />
            <span class="cv-kbd" aria-hidden="true">/</span>
          </label>

          <!-- Panel resultados -->
          <div id="searchPanel" class="search-panel" aria-live="polite">
            <div class="sp-header">
              <strong id="spCount">Escribe para buscar</strong>
              <button id="spClose" type="button" aria-label="Cerrar">✕</button>
            </div>
            <div id="spList" class="sp-list" role="list"></div>
            <div id="spFooter" class="sp-footer" hidden>
              <a href="#convocatorias" id="spSeeAll">Ver todos en Convocatorias</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- ===== Banner ===== -->
    <section class="banner_main" id="banner">
      <div id="myCarousel" class="carousel slide banner" data-ride="carousel" aria-label="Mensajes principales">
        <ol class="carousel-indicators">
          <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
          <li data-target="#myCarousel" data-slide-to="1"></li>
          <li data-target="#myCarousel" data-slide-to="2"></li>
        </ol>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <div class="container">
              <div class="carousel-caption relative">
                <div class="row">
                  <div class="col-md-7 offset-md-5">
                    <div class="text-bg">
                      <h1>Enciclopedia de<br>Animales Mexicanos</h1>
                      <span>Investigación, Difusión y Divulgación</span>
                      <a class="read_more" href="animales.html">Ver especies</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="container">
              <div class="carousel-caption relative">
                <div class="row">
                  <div class="col-md-7 offset-md-5">
                    <div class="text-bg">
                      <h1>Fichas verificadas</h1>
                      <span>Taxonomía, distribución, hábitat y estado UICN</span>
                      <a class="read_more" href="metodologia.html">Metodología</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="container">
              <div class="carousel-caption relative">
                <div class="row">
                  <div class="col-md-7 offset-md-5">
                    <div class="text-bg">
                      <h1>Colabora con la EAM</h1>
                      <span>Investigación y divulgación interdisciplinaria</span>
                      <a class="read_more" href="contact.html">Contactar</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev" aria-label="Anterior">
          <i class="fa fa-angle-left" aria-hidden="true"></i><span class="sr-only">Anterior</span>
        </a>
        <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next" aria-label="Siguiente">
          <i class="fa fa-angle-right" aria-hidden="true"></i><span class="sr-only">Siguiente</span>
        </a>
      </div>
    </section>

    <!-- Indicador -->
    <div class="text-center py-2" style="background:#f8fff9;border-bottom:1px solid var(--line)">
      <small>¿Buscas convocatorias? Más abajo o <a href="#convocatorias" class="read_more" style="padding:.35rem .6rem">ir a convocatorias</a></small>
    </div>

    <!-- ===== About ===== -->
    <div id="about" class="about">
      <div class="container">
        <div class="row">
          <div class="col-md-5">
            <div class="titlepage">
              <h2 id="sobre-la-enciclopedia">Sobre <span class="green">la Enciclopedia</span></h2>
              <p>
                La <strong>Enciclopedia de Animales Mexicanos</strong> documenta la fauna del país con estándares académicos: nombre común y científico, distribución, hábitat, estado de conservación y referencias verificables. Nuestro propósito es promover la conservación y el conocimiento público.
              </p>
              <a class="read_more" href="nosotros.html">Conoce más</a>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Servicios ===== -->
    <div id="service" class="service">
      <div class="container">
        <div class="row"><div class="col-md-12"><div class="titlepage"><h2 id="nuestros-contenidos">Nuestros <span class="green">contenidos</span></h2></div></div></div>
        <div class="row">
          <div class="col-md-10 offset-md-1">
            <div class="row">
              <div class="col-md-4 col-sm-6">
                <div class="service_box">
                  <i><img src="images/ajolote.png" alt="Fichas de especies" loading="lazy" decoding="async"/></i>
                  <h3>Fichas de especies</h3>
                  <p>Información validada: taxonomía, distribución, hábitat y estado UICN.</p>
                </div>
              </div>
              <div class="col-md-4 offset-md-1 col-sm-6">
                <div class="service_box">
                  <i><img src="images/ajolote.png" alt="Recursos educativos" loading="lazy" decoding="async"/></i>
                  <h3>Recursos educativos</h3>
                  <p>Guías y materiales para docentes y divulgadores.</p>
                </div>
              </div>
              <div class="col-md-4 offset-md-3 col-sm-6 mar_top">
                <div class="service_box">
                  <i><img src="images/ajolote.png" alt="Colaboraciones" loading="lazy" decoding="async"/></i>
                  <h3>Colaboraciones</h3>
                  <p>Proyectos interdisciplinarios con instituciones y comunidades.</p>
                </div>
              </div>
              <div class="col-md-4 offset-md-1 col-sm-6 mar_top">
                <div class="service_box">
                  <i><img src="images/ajolote.png" alt="Datos abiertos" loading="lazy" decoding="async"/></i>
                  <h3>Datos abiertos</h3>
                  <p>Publicación de conjuntos de datos y referencias trazables.</p>
                </div>
              </div>
              <div class="col-md-12"><a class="read_more" href="animales.html">Explorar especies</a></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Galería ===== -->
    <div id="gallery" class="gallery">
      <div class="container">
        <div class="row"><div class="col-md-12"><div class="titlepage"><h2 id="nuestra-galeria">Nuestra <span class="green">galería</span></h2><p>Imágenes ilustrativas de especies (con licencias y créditos correspondientes).</p></div></div></div>
        <div class="row">
          <div class="col-md-4 col-sm-6"><div class="gallery_text"><div class="galleryh3"><h3 id="gal-ajolote">Ajolote</h3><p>Anfibio endémico de Xochimilco (Ambystoma mexicanum).</p></div></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Ajolote" loading="lazy" decoding="async"/></figure></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Ajolote" loading="lazy" decoding="async"/></figure></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Ajolote" loading="lazy" decoding="async"/></figure></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Ajolote" loading="lazy" decoding="async"/></figure></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_text"><div class="galleryh3"><h3 id="gal-colibri">Colibrí</h3><p>Aves nectívoras de gran importancia polinizadora.</p></div></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_text"><div class="galleryh3"><h3 id="gal-jaguar">Jaguar</h3><p>Felino emblemático de Mesoamérica (Panthera onca).</p></div></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Imagen de ejemplo" loading="lazy" decoding="async"/></figure></div></div>
          <div class="col-md-4 col-sm-6"><div class="gallery_img"><figure><img src="images/ajolote.png" alt="Imagen de ejemplo" loading="lazy" decoding="async"/></figure></div></div>
        </div>
      </div>
    </div>

    <!-- ===== Diseño / líneas ===== -->
    <div class="design" id="lineas">
      <div class="container-fluid">
        <div class="row d_flex">
          <div class="col-md-5">
            <div id="design" class="carousel slide banner_design" data-ride="carousel" aria-label="Líneas de investigación">
              <ol class="carousel-indicators">
                <li data-target="#design" data-slide-to="0" class="active"></li>
                <li data-target="#design" data-slide-to="1"></li>
                <li data-target="#design" data-slide-to="2"></li>
              </ol>
              <div class="carousel-inner">
                <div class="carousel-item active"><div class="container"><div class="carousel-caption relative"><div class="row"><div class="col-md-12"><div class="text_de"><div class="titlepage"><h2 id="lineas-investigacion">Nuevas líneas de <span class="green">investigación</span></h2></div><p>Conservación de anfibios endémicos y monitoreo de hábitats urbanos.</p></div></div></div></div></div></div></div>
                <div class="carousel-item"><div class="container"><div class="carousel-caption relative"><div class="row"><div class="col-md-12"><div class="text_de"><div class="titlepage"><h2 id="divulgacion-cientifica">Divulgación <span class="green">científica</span></h2></div><p>Material didáctico para escuelas y actividades comunitarias.</p></div></div></div></div></div></div></div>
                <div class="carousel-item"><div class="container"><div class="carousel-caption relative"><div class="row"><div class="col-md-12"><div class="text_de"><div class="titlepage"><h2 id="datos-abiertos">Datos <span class="green">abiertos</span></h2></div><p>Publicación de conjuntos de datos y trazabilidad de fuentes.</p></div></div></div></div></div></div></div>
              </div>
              <a class="carousel-control-prev" href="#design" role="button" data-slide="prev" aria-label="Anterior"><i class="fa fa-angle-left" aria-hidden="true"></i><span class="sr-only">Anterior</span></a>
              <a class="carousel-control-next" href="#design" role="button" data-slide="next" aria-label="Siguiente"><i class="fa fa-angle-right" aria-hidden="true"></i><span class="sr-only">Siguiente</span></a>
            </div>
          </div>
          <div class="col-md-7 pad_roght0">
            <div class="design_img"><figure><img src="images/ajolote.png" alt="Ilustración de especie" loading="lazy" decoding="async"/></figure></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Avances ===== -->
    <div class="latest_news" id="avances">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="titlepage">
              <h2 id="avances-titulo">Avances <span class="green">interdisciplinarios</span></h2>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Avance 1 -->
          <div class="col-md-4 offset-md-2">
            <div id="avance-ajolotes" class="news_box">
              <div class="news_img">
                <figure><img src="images/ajolote.png" alt="Proyecto anfibios" loading="lazy" decoding="async"/></figure>
              </div>
              <div class="news_room">
                <span>Conservación</span>
                <ul>
                  <li><a href="#">Like <i class="fa fa-heart-o" aria-hidden="true"></i></a></li>
                  <li><a href="#">Comment <i class="fa fa-comments-o" aria-hidden="true"></i></a></li>
                  <li><a href="#">Share <i class="fa fa-share-alt" aria-hidden="true"></i></a></li>
                </ul>
                <h3>Programa de monitoreo de ajolotes</h3>
                <p>Colaboración con laboratorios locales para evaluar calidad de agua y poblaciones.</p>
              </div>
            </div>
          </div>

          <!-- Avance 2 -->
          <div class="col-md-4">
            <div id="avance-talleres-escuelas" class="news_box">
              <div class="news_img mr_le">
                <figure><img src="images/ajolote.png" alt="Material educativo" loading="lazy" decoding="async"/></figure>
              </div>
              <div class="news_room">
                <span>Divulgación</span>
                <ul>
                  <li><a href="#">Like <i class="fa fa-heart-o" aria-hidden="true"></i></a></li>
                  <li><a href="#">Comment <i class="fa fa-comments-o" aria-hidden="true"></i></a></li>
                  <li><a href="#">Share <i class="fa fa-share-alt" aria-hidden="true"></i></a></li>
                </ul>
                <h3>Talleres para escuelas</h3>
                <p>Actividades sobre biodiversidad urbana y especies emblemáticas.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== CONVOCATORIAS ===== -->
    <section class="convocatorias-section" id="convocatorias">
      <div class="container">
        <div class="row align-items-end">
          <div class="col-md-8">
            <div class="titlepage">
              <h2 id="convocatorias-titulo">Convocatorias <span class="green">EAM</span></h2>
              <p>Consulta convocatorias de investigación, voluntariado, talleres y colaboraciones.</p>
            </div>
          </div>
          <div class="col-md-4 text-md-right text-left mb-3">
            <div class="cv-tools" role="group" aria-label="Herramientas de filtrado">
              <select id="cvSort" class="cv-select" aria-label="Ordenar resultados">
                <option value="fecha-desc">Más próximas primero</option>
                <option value="fecha-asc">Más lejanas primero</option>
                <option value="az">Nombre (A–Z)</option>
                <option value="za">Nombre (Z–A)</option>
              </select>
              <button id="cvClearBtn" class="cv-btn" type="button" title="Limpiar filtros">Limpiar</button>
              <span id="cvCount" class="text-muted small" aria-live="polite"></span>
            </div>
            <div id="cvChipBar" class="cv-chips" aria-label="Filtrar por etiquetas"></div>
          </div>
        </div>

        <div id="cvGrid" class="pdf-grid" aria-live="polite">
          <article class="pdf-item" data-name="Convocatoria Ajolotes 2025.pdf" data-tags="voluntariado, 2025, anfibios" data-date="2025-06-01">
            <div class="preview">
              <embed class="pdf-embed lazy-embed" title="Convocatoria Ajolotes 2025" data-src="pdfs/Convocatoria-Ajolotes-2025.pdf#view=FitH" type="application/pdf" />
              <span class="hint">Vista previa</span>
            </div>
            <div class="pdf-meta">
              <div class="pdf-name">Convocatoria Ajolotes 2025.pdf</div>
              <div class="tag-row"><span class="badge-tag">voluntariado</span><span class="badge-tag">2025</span><span class="badge-tag">anfibios</span></div>
              <div class="actions">
                <a href="#" class="btn-linklike js-open-pdf" data-pdf="pdfs/Convocatoria-Ajolotes-2025.pdf" data-title="Convocatoria Ajolotes 2025">Ver aquí</a>
                <a class="btn-linklike" href="pdfs/Convocatoria-Ajolotes-2025.pdf" target="_blank" rel="noopener">Abrir</a>
                <a class="btn-linklike" href="pdfs/Convocatoria-Ajolotes-2025.pdf" download="Convocatoria Ajolotes 2025.pdf">Descargar</a>
              </div>
            </div>
          </article>

          <article class="pdf-item" data-name="Taller Divulgación Docente.pdf" data-tags="taller, divulgación, docentes" data-date="2025-04-10">
            <div class="preview">
              <embed class="pdf-embed lazy-embed" title="Taller de Divulgación para Docentes" data-src="pdfs/Taller-Divulgacion-Docentes.pdf#view=FitH" type="application/pdf" />
              <span class="hint">Vista previa</span>
            </div>
            <div class="pdf-meta">
              <div class="pdf-name">Taller Divulgación Docente.pdf</div>
              <div class="tag-row"><span class="badge-tag">taller</span><span class="badge-tag">divulgación</span><span class="badge-tag">docentes</span></div>
              <div class="actions>
                <a href="#" class="btn-linklike js-open-pdf" data-pdf="pdfs/Taller-Divulgacion-Docentes.pdf" data-title="Taller de Divulgación para Docentes">Ver aquí</a>
                <a class="btn-linklike" href="pdfs/Taller-Divulgacion-Docentes.pdf" target="_blank" rel="noopener">Abrir</a>
                <a class="btn-linklike" href="pdfs/Taller-Divulgacion-Docentes.pdf" download="Taller Divulgación Docente.pdf">Descargar</a>
              </div>
            </div>
          </article>
        </div>

        <div id="cvEmpty" class="cv-empty">Sin resultados. Ajusta la búsqueda o quita filtros.</div>
      </div>
    </section>

    <!-- ===== Fichas ===== -->
    <div id="testimonial" class="Testimonial">
      <div class="container-fluid">
        <div class="row d_flex">
          <div class="col-md-8 pad_left0">
            <div id="testimon" class="carousel slide banner_testimonial" data-ride="carousel" aria-label="Fichas destacadas">
              <ol class="carousel-indicators">
                <li data-target="#testimon" data-slide-to="0" class="active"></li>
                <li data-target="#testimon" data-slide-to="1"></li>
                <li data-target="#testimon" data-slide-to="2"></li>
              </ol>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <div class="container">
                    <div class="carousel-caption relative">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-ajolote">
                            <i><img src="images/ajolote.png" alt="Ajolote" loading="lazy" decoding="async"/></i>
                            <span>Ajolote</span>
                            <p>Ambystoma mexicanum — Especie endémica; indicador de salud de ecosistemas acuáticos.</p>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-colibri">
                            <i><img src="images/ajolote.png" alt="Colibrí" loading="lazy" decoding="async"/></i>
                            <span>Colibrí</span>
                            <p>Importante polinizador; diversidad alta en México.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="carousel-item">
                  <div class="container">
                    <div class="carousel-caption relative">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-jaguar">
                            <i><img src="images/ajolote.png" alt="Jaguar" loading="lazy" decoding="async"/></i>
                            <span>Jaguar</span>
                            <p>Panthera onca — Felino emblemático; conservación en corredores biológicos.</p>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-perrito-pradera">
                            <i><img src="images/ajolote.png" alt="Perrito de la pradera" loading="lazy" decoding="async"/></i>
                            <span>Perrito de la pradera</span>
                            <p>Cynomys mexicanus — Ingeniero del ecosistema en pastizales.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="carousel-item">
                  <div class="container">
                    <div class="carousel-caption relative">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-vaquita-marina">
                            <i><img src="images/ajolote.png" alt="Vaquita marina" loading="lazy" decoding="async"/></i>
                            <span>Vaquita marina</span>
                            <p>Phocoena sinus — En peligro crítico; esfuerzo internacional de conservación.</p>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="text_humai" id="ficha-tortuga-caguama">
                            <i><img src="images/ajolote.png" alt="Tortuga caguama" loading="lazy" decoding="async"/></i>
                            <span>Tortuga caguama</span>
                            <p>Caretta caretta — Migraciones largas; protección de playas de anidación.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
              <a class="carousel-control-prev" href="#testimon" role="button" data-slide="prev" aria-label="Anterior"><i class="fa fa-angle-left" aria-hidden="true"></i><span class="sr-only">Anterior</span></a>
              <a class="carousel-control-next" href="#testimon" role="button" data-slide="next" aria-label="Siguiente"><i class="fa fa-angle-right" aria-hidden="true"></i><span class="sr-only">Siguiente</span></a>
            </div>
          </div>
          <div class="col-md-4">
            <div class="titlepage">
              <h2 id="fichas-titulo">Fichas</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Contacto ===== -->
    <div id="contact" class="contact">
      <div class="container">
        <div class="row"><div class="col-md-12"><div class="titlepage"><h2 id="contacto-titulo">Contáctanos</h2></div></div></div>
        <div class="row">
          <div class="col-md-6">
            <form action="#" method="post" id="request" class="main_form" novalidate>
              <div class="row">
                <div class="col-md-12"><label class="sr-only" for="name">Nombre</label><input id="name" class="contactus" placeholder="Nombre" type="text" name="name" required></div>
                <div class="col-md-12"><label class="sr-only" for="email">Email</label><input id="email" class="contactus" placeholder="Email" type="email" name="email" required></div>
                <div class="col-md-12"><label class="sr-only" for="phone">Teléfono</label><input id="phone" class="contactus" placeholder="Teléfono" type="tel" name="phone"></div>
                <div class="col-md-12"><label class="sr-only" for="message">Mensaje</label><textarea id="message" class="textarea" placeholder="Mensaje" name="message" rows="5"></textarea></div>
                <div class="col-md-12"><button class="send_btn" type="submit">Enviar</button></div>
              </div>
            </form>
          </div>
          <div class="col-md-6">
            <div class="map_main">
              <div class="map-responsive">
                <iframe title="Mapa" src="https://www.google.com/maps?q=Xochimilco,+CDMX&output=embed" width="600" height="345" frameborder="0" style="border:0; width: 100%;" allowfullscreen loading="lazy"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Footer ===== -->
    <footer>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-3 col-sm-6">
              <ul class="social_icon">
                <li><a href="#"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                <li><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                <li><a href="#"><i class="fa fa-youtube" aria-hidden="true"></i></a></li>
                <li><a href="#"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
              </ul>
              <p class="variat pad_roght2">Enciclopedia de los Animales Mexicanos es un proyecto de difusión del conocimiento zoológico, histórico y cultural, comprometido con la preservación y el estudio de la biodiversidad nacional.</p>
            </div>
            <div class="col-md-3 col-sm-6">
              <h3>Contáctanos</h3>
              <p class="variat pad_roght2">¿Dudas o colaboraciones? Escríbenos:<br>contacto@eam.org</p>
            </div>
            <div class="col-md-3 col-sm-6">
              <h3>Enlaces útiles</h3>
              <ul class="link_menu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="nosotros.html">¿Quiénes somos?</a></li>
                <li><a href="animales.html">Especies</a></li>
                <li><a href="lineas-investigacion.html">Líneas de investigación</a></li>
                <li><a href="colaboradores.html">Colaboradores</a></li>
                <li><a href="contact.html">Contacto</a></li>
              </ul>
            </div>
            <div class="col-md-3 col-sm-6">
              <h3>Nuestra visión</h3>
              <p class="variat">Documentar y preservar el conocimiento etnohistórico y científico sobre la fauna de México, de forma abierta y verificable.</p>
            </div>
            <div class="col-md-6 offset-md-6">
              <form id="newsletter" class="bottom_form" action="#" method="post">
                <label class="sr-only" for="newsletter-email">Correo</label>
                <input id="newsletter-email" class="enter" placeholder="Tu correo electrónico" type="email" name="email" required>
                <button class="sub_btn" type="submit">Suscribirme</button>
              </form>
            </div>
          </div>
        </div>
        <div class="copyright">
          <div class="container">
            <div class="row"><div class="col-md-10 offset-md-1"><p>© 2025 Enciclopedia de los Animales Mexicanos. Todos los derechos reservados.</p></div></div>
          </div>
        </div>
      </div>
    </footer>

    <!-- ===== Modal PDF ===== -->
    <div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen-md-down modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="pdfTitle" class="modal-title">Documento</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body p-0">
            <embed id="pdfEmbed" type="application/pdf" src="" style="width:100%; height:80vh; border:0;" />
          </div>
          <div class="modal-footer">
            <a id="pdfOpenNew" class="btn btn-outline-success" target="_blank" rel="noopener">Abrir en pestaña</a>
            <button type="button" class="btn btn-success" data-dismiss="modal">Volver</button>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script defer src="js/jquery.min.js"></script>
    <script defer src="js/bootstrap.bundle.min.js"></script>
    <script defer src="js/jquery.mCustomScrollbar.concat.min.js"></script>
    <script defer src="js/custom.js"></script>

    <script>
      // ===== Helper seguros (evitan conflicto con jQuery $) =====
      const qs  = (q)=>document.querySelector(q);
      const qsa = (q)=>Array.from(document.querySelectorAll(q));
      const norm = s => (s||"").toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

      // Header sombra
      (function(){
        var h = document.getElementById('siteHeader');
        function onScroll(){ if(!h) return; (window.scrollY>8)?h.classList.add('stuck'):h.classList.remove('stuck'); }
        onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
      })();

      // Reduced motion
      (function(){
        try{
          var reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          if (reduce) { ['myCarousel','testimon','design'].forEach(function(id){ 
            var el=document.getElementById(id); 
            if (el && window.jQuery && window.jQuery(el).carousel) window.jQuery(el).carousel({ interval:false, ride:false }); 
          }); }
        }catch(e){}
      })();

      // ===== RUTAS DIRECTAS POR PALABRA CLAVE =====
      const KEY_ROUTES = [
        { terms:['fichas','ficha','especies'], title:'Fichas', url:'#testimonial', type:'Sección', meta:'Fichas destacadas' },
        { terms:['animalidad y humanidad','animalidad','humanidad'], title:'Animalidad y Humanidad', url:'humanidad-animalidad.html', type:'Sección', meta:'Sección' },
        { terms:['filosofia','filosofía'], title:'Filosofía', url:'humanidad-animalidad.html#filosofia', type:'Sección', meta:'Humanidad' },
        { terms:['literatura'], title:'Literatura', url:'humanidad-animalidad.html#literatura', type:'Sección', meta:'Humanidad' },
        { terms:['artes','arte'], title:'Artes', url:'humanidad-animalidad.html#artes', type:'Sección', meta:'Humanidad' },
        { terms:['juridicas','jurídicas','derecho'], title:'Jurídicas', url:'humanidad-animalidad.html#juridicas', type:'Sección', meta:'Humanidad' },
        { terms:['arquitectura'], title:'Arquitectura', url:'humanidad-animalidad.html#arquitectura', type:'Sección', meta:'Humanidad' },
      ];

      // ===== CONVOCATORIAS (chips + filtro + lazy embed + modal) =====
      (function(){
        const headerQ = qs('#headerQ');
        const sortSel = qs('#cvSort');
        const clearBtn = qs('#cvClearBtn');
        const chipBar = qs('#cvChipBar');
        const count = qs('#cvCount');
        const emptyEl = qs('#cvEmpty');
        const grid = qs('#cvGrid');

        const obs = ('IntersectionObserver' in window) ? new IntersectionObserver((entries,o)=>{
          for(const e of entries){
            if(e.isIntersecting){
              const el = e.target; const src = el.getAttribute('data-src');
              if(src){ el.setAttribute('src', src); el.removeAttribute('data-src'); }
              o.unobserve(el);
            }
          }
        }, {rootMargin:'200px'}) : null;

        function hydrateLazy(){
          qsa('.lazy-embed[data-src]').forEach(el=>{
            if(obs) obs.observe(el);
            else el.setAttribute('src', el.getAttribute('data-src'));
          });
        }

        const selected = new Set();
        function buildChips(){
          const tagMap = new Map();
          qsa('.pdf-item').forEach(it=>{
            const tags = (it.getAttribute('data-tags')||'').split(',').map(t=>t.trim()).filter(Boolean);
            for(const t of tags){ tagMap.set(t, (tagMap.get(t)||0)+1); }
          });
          chipBar.innerHTML='';
          [...tagMap.keys()].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'})).forEach(tag=>{
            const b=document.createElement('button'); b.type='button'; b.className='cv-chip'; b.textContent=tag; b.setAttribute('aria-pressed','false');
            b.addEventListener('click', ()=>{
              if(selected.has(tag)){ selected.delete(tag); b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }
              else { selected.add(tag); b.classList.add('active'); b.setAttribute('aria-pressed','true'); }
              applyFilter();
            });
            chipBar.appendChild(b);
          });
        }

        function sortItems(items){
          const mode = sortSel ? sortSel.value : 'fecha-desc';
          const byName = (a,b)=> norm(a.getAttribute('data-name')).localeCompare(norm(b.getAttribute('data-name')),'es');
          const parseDate = (it)=>{
            const name = it.getAttribute('data-name')||'';
            const m = name.match(/\b(20\d{2}|19\d{2})\b/);
            return m ? new Date(+m[1], 0, 1) : new Date(2100,0,1);
          };
          if(mode==='az') return items.sort(byName);
          if(mode==='za') return items.sort((a,b)=>-byName(a,b));
          if(mode==='fecha-asc') return items.sort((a,b)=> parseDate(a)-parseDate(b));
          return items.sort((a,b)=> parseDate(b)-parseDate(a));
        }

        function applyFilter(){
          const needle = norm(headerQ ? headerQ.value : '');
          const items = qsa('.pdf-item');
          let list = items.slice();

          if(selected.size){
            list = list.filter(it=>{
              const raw = (it.getAttribute('data-tags')||'').split(',').map(s=>s.trim());
              return [...selected].some(t => raw.includes(t));
            });
          }
          if(needle){
            list = list.filter(it=>{
              const name = norm(it.getAttribute('data-name'));
              const tags = norm(it.getAttribute('data-tags')||'');
              return name.includes(needle) || tags.includes(needle);
            });
          }

          const setHidden = new Set(list);
          items.forEach(it=> it.classList.toggle('hide', !setHidden.has(it)));
          sortItems(list).forEach(el=> grid.appendChild(el));

          const visible = list.length;
          if(count) count.textContent = `${visible} resultado${visible===1?'':'s'}`;
          if(emptyEl) emptyEl.style.display = visible ? 'none' : 'block';

          hydrateLazy();
        }

        function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }

        if(headerQ) headerQ.addEventListener('input', debounce(applyFilter,120));
        if(sortSel) sortSel.addEventListener('change', applyFilter);
        if(clearBtn) clearBtn.addEventListener('click', ()=>{
          if(headerQ) headerQ.value='';
          selected.clear();
          qsa('.cv-chip.active').forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
          applyFilter();
          if(headerQ) headerQ.focus();
        });
        window.addEventListener('keydown', (e)=>{
          if(e.key==='/' && document.activeElement!==headerQ){ e.preventDefault(); if(headerQ) headerQ.focus(); }
          if(e.key==='Escape'){ if(clearBtn) clearBtn.click(); }
        });

        // Modal PDF (usar jQuery explícito para evitar choque con helpers)
        const modalEl = document.getElementById('pdfModal');
        const pdfTitle = document.getElementById('pdfTitle');
        const pdfEmbed = document.getElementById('pdfEmbed');
        const pdfOpenNew = document.getElementById('pdfOpenNew');

        function openPdf(url, title){
          pdfTitle.textContent = title || 'Documento';
          pdfEmbed.setAttribute('src', url + '#view=FitH');
          pdfOpenNew.setAttribute('href', url);
          if (window.jQuery && window.jQuery(modalEl).modal) { window.jQuery(modalEl).modal('show'); }
        }
        if (modalEl && window.jQuery){
          window.jQuery(modalEl).on('hidden.bs.modal', function(){ pdfEmbed.removeAttribute('src'); });
        }
        qsa('.js-open-pdf').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.preventDefault();
            const url = btn.getAttribute('data-pdf');
            const title = btn.getAttribute('data-title') || btn.textContent.trim();
            if(url) openPdf(url, title);
          });
        });

        window.filterConvocatorias = function(term){
          const header = qs('#headerQ');
          if(header){ header.value = term || ''; }
          applyFilter();
        };

        buildChips();
        applyFilter();
        hydrateLazy();
      })();

      // ===== BUSCADOR DEL HEADER (panel + rutas + teclado) =====
      (function(){
        const headerQ = qs('#headerQ');
        const panel   = qs('#searchPanel');
        const spList  = qs('#spList');
        const spCount = qs('#spCount');
        const spClose = qs('#spClose');
        const spFooter= qs('#spFooter');
        const spSeeAll= qs('#spSeeAll');

        function highlight(text, q){
          const n = norm(text), m = norm(q);
          if(!m) return text;
          const i = n.indexOf(m);
          if(i<0) return text;
          return text.substring(0,i) + '<span class="hl">' + text.substring(i, i+m.length) + '</span>' + text.substring(i+m.length);
        }

        function applyConvFilter(term){
          if (typeof window.filterConvocatorias === 'function'){
            window.filterConvocatorias(term || '');
          }
        }

        const index = [];
        function buildIndex(){
          index.length = 0;

          // Rutas clave sugeridas
          KEY_ROUTES.forEach(r=>{
            index.push({ type:r.type, title:r.title, url:r.url, meta:r.meta||'', tags:[], __route: true, terms:r.terms });
          });

          // Menú principal
          qsa('header nav a').forEach(a=>{
            index.push({
              type:'Sección',
              title:a.textContent.trim(),
              url:a.getAttribute('href')||'#',
              meta:'Navegación',
              tags:[]
            });
          });

          // Convocatorias (tarjetas)
          qsa('#cvGrid .pdf-item').forEach(card=>{
            const name = card.getAttribute('data-name') || (card.querySelector('.pdf-name') ? card.querySelector('.pdf-name').textContent : 'Documento');
            const tagsRaw = (card.getAttribute('data-tags') || '').split(',').map(t=>t.trim()).filter(Boolean);
            index.push({
              type:'Convocatoria',
              title:name,
              url:'#convocatorias',
              meta:tagsRaw.join(', '),
              tags:tagsRaw
            });
          });

          // Animales (galería y fichas)
          qsa('#gallery .galleryh3 h3').forEach(h=>{
            index.push({ type:'Animal', title:h.textContent.trim(), url:'#gallery', meta:'Galería', tags:[] });
          });
          qsa('#testimonial .text_humai span').forEach(s=>{
            const cont = s.closest('.text_humai');
            const id = cont && cont.id ? cont.id : 'testimonial';
            index.push({ type:'Animal', title:s.textContent.trim(), url:'#'+id, meta:'Fichas', tags:[] });
          });

          // Títulos de secciones (h2 con id)
          const anchorTargets = [
            '#sobre-la-enciclopedia',
            '#nuestros-contenidos',
            '#nuestra-galeria',
            '#lineas-investigacion',
            '#divulgacion-cientifica',
            '#datos-abiertos',
            '#avances-titulo',
            '#convocatorias-titulo',
            '#fichas-titulo',
            '#contacto-titulo'
          ];
          qsa(anchorTargets.join(',')).forEach(el=>{
            const id = el.getAttribute('id');
            const text = el.textContent.trim();
            if(id && text){
              index.push({ type:'Sección', title:text, url:'#'+id, meta:'Sección', tags:[] });
            }
          });

          // Avances específicos (news_box con id -> usar su h3 como título)
          qsa('.latest_news .news_box[id]').forEach(box=>{
            const id = box.id;
            const h3 = box.querySelector('h3');
            if(id && h3){
              index.push({ type:'Avance', title:h3.textContent.trim(), url:'#'+id, meta:'Avances', tags:[] });
            }
          });
        }
        buildIndex();

        function bestKeyRoute(q){
          const m = norm(q);
          if(!m) return null;
          for(const r of KEY_ROUTES){
            if(r.terms.some(t => norm(t).startsWith(m) || m.includes(norm(t)) )){
              return r;
            }
          }
          return null;
        }

        function search(q){
          const needle = norm(q);
          if(!needle) return [];

          const scored = index.map(it=>{
            const hay = norm(it.title + ' ' + (it.meta||'') + ' ' + (it.tags||[]).join(' '));
            let score = 0;
            if(hay.includes(needle)) score += 10;
            if(norm(it.title).startsWith(needle)) score += 6;
            if(it.__route && hay.includes(needle)) score += 12;
            if(it.type==='Convocatoria' && hay.includes(needle)) score += 2;
            if(it.type==='Avance' && hay.includes(needle)) score += 2;
            return {item:it, score};
          }).filter(x=>x.score>0);

          scored.sort((a,b)=> b.score - a.score || a.item.title.localeCompare(b.item.title,'es'));
          return scored.map(x=>x.item);
        }

        function convocatoriaMatches(term){
          const needle = norm(term);
          const items = qsa('#cvGrid .pdf-item');
          const out = [];
          items.forEach(it=>{
            const name = norm(it.getAttribute('data-name'));
            const tags = norm(it.getAttribute('data-tags')||'');
            if(!needle || name.includes(needle) || tags.includes(needle)){
              out.push({ title: it.getAttribute('data-name') || 'Documento', meta:  it.getAttribute('data-tags') || '' });
            }
          });
          return out;
        }

        function iconFor(type){
          if(type==='Sección') return '<i class="fa fa-compass sp-ico" aria-hidden="true"></i>';
          if(type==='Convocatoria') return '<i class="fa fa-file-pdf-o sp-ico" aria-hidden="true"></i>';
          if(type==='Avance') return '<i class="fa fa-flask sp-ico" aria-hidden="true"></i>';
          return '<i class="fa fa-paw sp-ico" aria-hidden="true"></i>';
        }

        let activeIndex = -1;

        function renderPanel(term){
          const q = term || '';
          const key = bestKeyRoute(q);
          const results = q ? search(q) : [];
          const convos  = q ? convocatoriaMatches(q) : [];
          const top = (key && !results.some(r=>r.url===key.url))
            ? [ {type:key.type,title:key.title,url:key.url,meta:key.meta||'',tags:[], __route:true} , ...results].slice(0,12)
            : results.slice(0,12);

          spCount.textContent = q ? `${results.length} resultado${results.length===1?'':'s'}` : 'Escribe para buscar';

          if (q && top.length === 0){
            spList.innerHTML = `
              <div class="sp-item" role="listitem" style="cursor:default">
                <div class="sp-ico"></div>
                <div class="sp-main">
                  <div class="sp-title">Sin resultados</div>
                  <div class="sp-meta">Prueba con otro término o pulsa Enter para ver convocatorias filtradas</div>
                </div>
              </div>`;
          } else {
            spList.innerHTML = top.map((it,i)=>{
              const chips = (it.type==='Convocatoria' && it.tags && it.tags.length)
                ? `<div class="sp-tags">${it.tags.slice(0,4).map(t=>`<span class="sp-chip">${t}</span>`).join('')}</div>`
                : '';
              const titleHL = highlight(it.title, q);
              const metaHL  = highlight(it.meta||'', q);
              return `
                <div class="sp-item" role="listitem" data-i="${i}">
                  ${iconFor(it.type)}
                  <div class="sp-main">
                    <div><span class="sp-type">${it.type}</span> <span class="sp-title" title="${it.title}">${titleHL}</span></div>
                    <div class="sp-meta">${metaHL}</div>
                    ${chips}
                  </div>
                </div>`;
            }).join('');
          }

          if (q && convos.length){
            spFooter.hidden = false;
            spSeeAll.onclick = (e)=>{ e.preventDefault(); applyConvFilter(q); location.hash = '#convocatorias'; hidePanel(); };
            spSeeAll.textContent = `Ver ${convos.length} en Convocatorias`;
          } else {
            spFooter.hidden = true;
          }

          qsa('.sp-item[data-i]').forEach(row=>{
            row.addEventListener('click', ()=>{
              const i = +row.getAttribute('data-i');
              const it = top[i];
              if(!it) return;
              if(it.type === 'Convocatoria'){ applyConvFilter(q || it.title); location.hash = '#convocatorias'; }
              else if(it.url){ location.href = it.url; }
              hidePanel();
            });
          });

          activeIndex = -1;
          if(q.length>=1){ showPanel(); } else { hidePanel(); }
        }

        function showPanel(){ panel.style.display='block'; }
        function hidePanel(){ panel.style.display='none'; }

        function moveSelection(dir){
          const rows = Array.from(spList.querySelectorAll('.sp-item[data-i]'));
          if(!rows.length) return;
          activeIndex += dir;
          if(activeIndex < 0) activeIndex = rows.length - 1;
          if(activeIndex >= rows.length) activeIndex = 0;
          rows.forEach(r=>r.classList.remove('active'));
          const active = rows[activeIndex];
          active.classList.add('active');
          active.scrollIntoView({ block:'nearest' });
        }
        function activateSelection(q){
          const rows = Array.from(spList.querySelectorAll('.sp-item[data-i]'));
          if(rows.length && activeIndex>=0){
            rows[activeIndex].click();
            return;
          }
          const key = bestKeyRoute(q);
          if(key){ location.href = key.url; hidePanel(); return; }
          if(q && typeof window.filterConvocatorias === 'function'){
            window.filterConvocatorias(q); location.hash = '#convocatorias'; hidePanel();
          }
        }

        if(headerQ){
          const deb = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
          headerQ.addEventListener('input', deb((e)=>{
            const val = e.target.value;
            applyConvFilter(val);
            renderPanel(val);
          }, 120));

          headerQ.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'){ e.preventDefault(); activateSelection(headerQ.value.trim()); }
            else if(e.key==='ArrowDown'){ e.preventDefault(); moveSelection(1); }
            else if(e.key==='ArrowUp'){ e.preventDefault(); moveSelection(-1); }
            else if(e.key==='Escape'){ hidePanel(); }
          });

          headerQ.addEventListener('focus', ()=>{
            if(headerQ.value && headerQ.value.length>=1){ showPanel(); }
          });
        }

        if(spClose) spClose.addEventListener('click', hidePanel);
        document.addEventListener('click', (ev)=>{
          const within = panel.contains(ev.target) || (ev.target===headerQ) || (headerQ && headerQ.contains(ev.target));
          if(!within) hidePanel();
        });

        // Atajo global "/"
        document.addEventListener('keydown', (e)=>{
          const t = document.activeElement && document.activeElement.tagName;
          if(e.key==='/' && document.activeElement!==headerQ && t!=='INPUT' && t!=='TEXTAREA'){
            e.preventDefault();
            if(headerQ) headerQ.focus();
          }
        });
      })();
    </script>
  </body>
</html>
